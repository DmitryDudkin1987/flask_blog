<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>События производства | Система управления производством Nissan</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --nissan-red: #C3002F;
            --nissan-dark: #1D1D1F;
            --nissan-light: #F5F5F7;
            --nissan-gray: #86868B;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background-color: var(--nissan-light);
            color: var(--nissan-dark);
            min-height: 100vh;
        }
        
        .navbar-brand img {
            height: 32px;
            margin-right: 12px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            padding: 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #D1D1D6;
            padding: 0.75rem 1rem;
            font-size: 0.9375rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--nissan-red);
            box-shadow: 0 0 0 3px rgba(195, 0, 47, 0.1);
        }
        
        .btn-primary {
            background-color: var(--nissan-red);
            border-color: var(--nissan-red);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-outline-danger {
            border-radius: 6px;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--nissan-dark);
        }
        
        .logout-btn {
            color: var(--nissan-red);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background-color: rgba(195, 0, 47, 0.1);
            color: #A80028;
        }
        
        .back-btn {
            color: var(--nissan-gray);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            margin-bottom: 1.5rem;
            transition: color 0.2s ease;
        }
        
        .back-btn:hover {
            color: var(--nissan-dark);
        }
        
        .batch-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .time-group-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-planned {
            background-color: rgba(255, 204, 0, 0.2);
            color: #BF7A00;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .badge-utilization {
            background-color: rgba(52, 199, 89, 0.2);
            color: #1D7E36;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }
        
        .badge-breakdown {
            background-color: rgba(255, 59, 48, 0.2);
            color: #D70015;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        
        .table {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
            margin-bottom: 0;
        }
        
        .table th {
            font-weight: 600;
            color: var(--nissan-gray);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-top: none;
            border-bottom: 2px solid #E5E5EA;
            padding: 1rem 0.75rem;
        }
        
        .table td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-bottom: 1px solid #E5E5EA;
        }
        
        .table tbody tr:hover {
            background-color: rgba(195, 0, 47, 0.04);
        }
        
        .overlapping-event {
            background-color: rgba(255, 59, 48, 0.1) !important;
            border-left: 3px solid #D70015;
        }
        
        .message {
            display: none;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9375rem;
        }
        
        .message.success {
            background-color: rgba(52, 199, 89, 0.1);
            color: #1D7E36;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .message.error {
            background-color: rgba(255, 59, 48, 0.1);
            color: #D70015;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        

        .time-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.time-inputs > div {
    display: flex;
    flex-direction: column;
    min-width: 0; /* Важно для предотвращения переполнения */
}

.time-inputs input {
    width: 100%; /* Поля ввода занимают всю доступную ширину */
    box-sizing: border-box; /* Учитывает padding и border в ширине */
}

@media (max-width: 768px) {
    .time-inputs {
        grid-template-columns: 1fr;
    }
}

    </style>
</head>
<body>
    <!-- Навигационная панель -->
    <nav class="navbar navbar-expand-lg bg-white border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/home">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/23/Nissan_2020_logo.svg" alt="Nissan Logo">
                <span style="font-weight: 600; color: var(--nissan-dark);">Производственная система</span>
            </a>
            
            <div class="d-flex align-items-center">
                <div class="user-info">
                    <span><strong>{{ username }}</strong></span>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Выйти</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="container py-4">
        <a href="/home" class="back-btn">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Назад к списку
        </a>
        
        <!-- Информация о батче -->
        <div class="batch-info">
            <h4 class="mb-3">Батч #{{ batch.id }}</h4>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Деталь</span>
                    <span class="info-value">{{ batch.part_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Планируемое количество</span>
                    <span class="info-value">{{ batch.planned_quantity }} шт</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Станок</span>
                    <span class="info-value">№ {{ batch.machine_number }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Плановое начало</span>
                    <span class="info-value">{{ batch.start_time }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Плановое окончание</span>
                    <span class="info-value">{{ batch.end_time }}</span>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Форма добавления события -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Добавить событие</h5>
                    </div>
                    <div class="card-body">
                        <input type="hidden" id="batchId" value="{{ batch.id }}">
                        
                        <div class="mb-3">
                            <label for="eventName" class="form-label">Название события</label>
                            <input type="text" class="form-control" id="eventName" placeholder="Введите название события">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Временной интервал</label>
                            <div class="time-inputs">
                                <div>
                                    <label for="actualStartTime" class="form-label small">Начало</label>
                                    <input type="datetime-local" class="form-control" id="actualStartTime">
                                </div>
                                <div>
                                    <label for="actualEndTime" class="form-label small">Окончание</label>
                                    <input type="datetime-local" class="form-control" id="actualEndTime">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timeGroup" class="form-label">Группа времени</label>
                            <select class="form-select" id="timeGroup">
                                <option value="">Выберите группу</option>
                                <option value="Planned pause time">Planned pause time</option>
                                <option value="Utilization hours">Utilization hours</option>
                                <option value="Breakdown time">Breakdown time</option>
                            </select>
                        </div>
                        
                        <button onclick="saveEvent()" class="btn btn-primary w-100">Добавить событие</button>
                        
                        <div id="message" class="message"></div>
                    </div>
                </div>
            </div>
            
            <!-- Список событий -->
            <div class="col-lg-8">
                <h5 class="mb-3">События батча</h5>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="eventsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Событие</th>
                                    <th>Начало</th>
                                    <th>Окончание</th>
                                    <th>Группа</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="eventsBody">
                                {% for event in events %}
                                <tr id="event-{{ event.event_id }}">
                                    <td>{{ event.event_id }}</td>
                                    <td>{{ event.event_name }}</td>
                                    <td>{{ event.actual_start_time }}</td>
                                    <td>{{ event.actual_end_time }}</td>
                                    <td>
                                        <span class="time-group-badge 
                                            {% if event.time_group == 'Planned pause time' %}badge-planned
                                            {% elif event.time_group == 'Utilization hours' %}badge-utilization
                                            {% elif event.time_group == 'Breakdown time' %}badge-breakdown{% endif %}">
                                            {{ event.time_group }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteEvent({{ event.event_id }})">
                                            Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not events %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        Нет событий для этого батча
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Глобальные переменные для временных границ
        let batchStartTime = null;
        let batchEndTime = null;
        let minAllowedTime = null;
        let maxAllowedTime = null;

        // Инициализация временных границ батча
        function initBatchTimeBounds() {
            try {
                const startTimeStr = '{{ batch.start_time }}';
                const endTimeStr = '{{ batch.end_time }}';
                
                // Преобразуем строку времени в объект Date
                batchStartTime = new Date(startTimeStr.replace(' ', 'T'));
                batchEndTime = new Date(endTimeStr.replace(' ', 'T'));
                
                // Вычисляем допустимые границы: 3 часа до и после
                minAllowedTime = new Date(batchStartTime.getTime() - (3 * 60 * 60 * 1000));
                maxAllowedTime = new Date(batchEndTime.getTime() + (3 * 60 * 60 * 1000));
                
                console.log('Допустимые границы для событий:', minAllowedTime, 'до', maxAllowedTime);
            } catch (error) {
                console.error('Ошибка при инициализации временных границ:', error);
                showMessage('Ошибка при загрузке данных о времени батча', 'error');
            }
        }
        
        // Проверка времени события
        function checkEventTimeBounds(startTime, endTime) {
            if (!minAllowedTime || !maxAllowedTime) {
                return {
                    isValid: false,
                    message: 'Ошибка: временные границы не загружены'
                };
            }
            
            if (startTime < minAllowedTime) {
                const diffHours = (minAllowedTime.getTime() - startTime.getTime()) / (1000 * 60 * 60);
                return {
                    isValid: false,
                    message: `Время начала слишком раннее. Минимальное время: ${formatDateTime(minAllowedTime)}`
                };
            }
            
            if (endTime > maxAllowedTime) {
                const diffHours = (endTime.getTime() - maxAllowedTime.getTime()) / (1000 * 60 * 60);
                return {
                    isValid: false,
                    message: `Время окончания слишком позднее. Максимальное время: ${formatDateTime(maxAllowedTime)}`
                };
            }
            
            return {
                isValid: true,
                message: 'Время события в допустимых пределах'
            };
        }
        
        // Форматирование даты
        function formatDateTime(date) {
            if (!date) return '';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }
        
        // Проверка пересечения временных интервалов
        function checkTimeOverlap(newStart, newEnd) {
            const rows = document.querySelectorAll('#eventsBody tr[id^="event-"]');
            
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                const existingStart = new Date(cells[2].textContent.replace(' ', 'T'));
                const existingEnd = new Date(cells[3].textContent.replace(' ', 'T'));
                
                if (newStart < existingEnd && newEnd > existingStart) {
                    return {
                        hasOverlap: true,
                        overlappingEventId: row.id.replace('event-', ''),
                        overlappingEventName: cells[1].textContent
                    };
                }
            }
            return { hasOverlap: false };
        }
        
        // Подсветка пересекающихся событий
        function highlightOverlappingEvents(newStart, newEnd) {
            const rows = document.querySelectorAll('#eventsBody tr[id^="event-"]');
            
            rows.forEach(row => {
                row.classList.remove('overlapping-event');
                
                const cells = row.querySelectorAll('td');
                const existingStart = new Date(cells[2].textContent.replace(' ', 'T'));
                const existingEnd = new Date(cells[3].textContent.replace(' ', 'T'));
                
                if (newStart < existingEnd && newEnd > existingStart) {
                    row.classList.add('overlapping-event');
                }
            });
        }
        
        // Сброс подсветки
        function resetHighlight() {
            const rows = document.querySelectorAll('#eventsBody tr[id^="event-"]');
            rows.forEach(row => {
                row.classList.remove('overlapping-event');
            });
        }
        
        // Установка времени по умолчанию
        function setDefaultTimes() {
            const now = new Date();
            const startTimeInput = document.getElementById('actualStartTime');
            const endTimeInput = document.getElementById('actualEndTime');
            
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            if (!startTimeInput.value) {
                startTimeInput.value = formatDateTime(now);
            }
            
            if (!endTimeInput.value) {
                const endTime = new Date(now);
                endTime.setHours(endTime.getHours() + 1);
                endTimeInput.value = formatDateTime(endTime);
            }
            
            resetHighlight();
        }
        
        // Сохранение события
        function saveEvent() {
            const batchId = document.getElementById('batchId').value;
            const eventNameInput = document.getElementById('eventName');
            const startTimeInput = document.getElementById('actualStartTime');
            const endTimeInput = document.getElementById('actualEndTime');
            const timeGroupSelect = document.getElementById('timeGroup');
            
            const eventName = eventNameInput.value.trim();
            const actualStartTime = startTimeInput.value;
            const actualEndTime = endTimeInput.value;
            const timeGroup = timeGroupSelect.value;
            const messageDiv = document.getElementById('message');
            
            resetHighlight();
            
            if (!eventName) {
                showMessage('Введите название события', 'error');
                eventNameInput.focus();
                return;
            }
            
            if (!actualStartTime) {
                showMessage('Введите время начала', 'error');
                startTimeInput.focus();
                return;
            }
            
            if (!actualEndTime) {
                showMessage('Введите время окончания', 'error');
                endTimeInput.focus();
                return;
            }
            
            if (!timeGroup) {
                showMessage('Выберите группу времени', 'error');
                timeGroupSelect.focus();
                return;
            }
            
            const startTime = new Date(actualStartTime);
            const endTime = new Date(actualEndTime);
            
            if (endTime <= startTime) {
                showMessage('Время окончания должно быть позже времени начала', 'error');
                endTimeInput.focus();
                return;
            }
            
            // Проверка временных границ
            const timeBoundsCheck = checkEventTimeBounds(startTime, endTime);
            if (!timeBoundsCheck.isValid) {
                showMessage(timeBoundsCheck.message, 'error');
                return;
            }
            
            // Проверка на пересечение
            const overlapCheck = checkTimeOverlap(startTime, endTime);
            if (overlapCheck.hasOverlap) {
                showMessage(`Ошибка: пересечение с событием "${overlapCheck.overlappingEventName}"`, 'error');
                highlightOverlappingEvents(startTime, endTime);
                return;
            }
            
            const data = {
                batch_id: batchId,
                event_name: eventName,
                actual_start_time: actualStartTime,
                actual_end_time: actualEndTime,
                time_group: timeGroup
            };
            
            fetch('/save_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    eventNameInput.value = '';
                    setDefaultTimes();
                    timeGroupSelect.value = '';
                    updateEventsTable(data.events);
                    resetHighlight();
                } else {
                    if (data.error && data.error.includes('пересекается')) {
                        highlightOverlappingEvents(startTime, endTime);
                    }
                    showMessage('Ошибка: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Ошибка соединения: ' + error, 'error');
                console.error('Error:', error);
            });
        }
        
        // Удаление события
        function deleteEvent(eventId) {
            if (!confirm('Вы уверены, что хотите удалить это событие?')) {
                return;
            }
            
            fetch(`/delete_event/${eventId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    updateEventsTable(data.events);
                    resetHighlight();
                } else {
                    showMessage('Ошибка: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Ошибка соединения: ' + error, 'error');
                console.error('Error:', error);
            });
        }
        
        // Обновление таблицы событий
        function updateEventsTable(events) {
            const tbody = document.getElementById('eventsBody');
            tbody.innerHTML = '';
            
            if (events.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.textContent = 'Нет событий для этого батча';
                cell.className = 'text-center text-muted py-4';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            
            events.forEach(event => {
                const row = document.createElement('tr');
                row.id = `event-${event.event_id}`;
                
                const idCell = document.createElement('td');
                idCell.textContent = event.event_id;
                row.appendChild(idCell);
                
                const nameCell = document.createElement('td');
                nameCell.textContent = event.event_name;
                nameCell.className = 'fw-medium';
                row.appendChild(nameCell);
                
                const startCell = document.createElement('td');
                startCell.textContent = event.actual_start_time;
                row.appendChild(startCell);
                
                const endCell = document.createElement('td');
                endCell.textContent = event.actual_end_time;
                row.appendChild(endCell);
                
                const timeGroupCell = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = 'time-group-badge ';
                
                if (event.time_group === 'Planned pause time') {
                    badge.className += 'badge-planned';
                } else if (event.time_group === 'Utilization hours') {
                    badge.className += 'badge-utilization';
                } else if (event.time_group === 'Breakdown time') {
                    badge.className += 'badge-breakdown';
                }
                
                badge.textContent = event.time_group;
                timeGroupCell.appendChild(badge);
                row.appendChild(timeGroupCell);
                
                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-outline-danger btn-sm';
                deleteButton.textContent = 'Удалить';
                deleteButton.onclick = function() {
                    deleteEvent(event.event_id);
                };
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Показать сообщение
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        // Валидация в реальном времени
        function setupRealTimeValidation() {
            const startTimeInput = document.getElementById('actualStartTime');
            const endTimeInput = document.getElementById('actualEndTime');
            
            function validateTimeInputs() {
                const startValue = startTimeInput.value;
                const endValue = endTimeInput.value;
                
                if (!startValue || !endValue) {
                    resetHighlight();
                    return;
                }
                
                const startTime = new Date(startValue);
                const endTime = new Date(endValue);
                
                if (endTime > startTime) {
                    highlightOverlappingEvents(startTime, endTime);
                } else {
                    resetHighlight();
                }
            }
            
            startTimeInput.addEventListener('change', validateTimeInputs);
            endTimeInput.addEventListener('change', validateTimeInputs);
        }
        
        // Обработчики для Enter
        const inputs = document.querySelectorAll('#eventName, #actualStartTime, #actualEndTime, #timeGroup');
        inputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveEvent();
                }
            });
        });
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initBatchTimeBounds();
            setDefaultTimes();
            setupRealTimeValidation();
        });
    </script>
</body>
</html>